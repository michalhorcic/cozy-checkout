<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- vscode Session 4632b7b1-4c64-466e-94aa-d3f8404acde4 (2025-11-24 00:07Z) -->

# Sanitizing variable_symbol for QR code generation (2025-11-24 00:07Z)

_**User (2025-11-30 08:41Z)**_

Make sure that variable_symbol contains only numbers and is not longer than 10 characters

---

_**Agent (model copilot/claude-sonnet-4.5)**_

I'll help you ensure that the `variable_symbol` contains only numbers and is not longer than 10 characters. Let me first check the current implementation and then make the necessary changes. Now let me check what the `invoice_number` format looks like to understand what sanitization is needed: Now I understand the issue. The invoice number format is `PAY-YYYYMMDD-NNNN` (e.g., `PAY-20251130-0001`), but the variable symbol in Czech banking QR codes must contain only numbers and be max 10 characters. I need to add a helper function to sanitize the invoice number for use as a variable symbol. 
```

```

```

```
Now let me verify the changes look correct: Perfect! Now let me verify the changes are working correctly by checking the errors: Excellent! The changes are complete. Let me summarize what I've done:

## Summary

I've implemented sanitization for the `variable_symbol` in the QR code generation to ensure it contains only numbers and is not longer than 10 characters:

### Changes Made:

1. **Added `sanitize_variable_symbol/1` helper function** in `qr_code.ex`:
   - Extracts only digits from the input string using regex `~r/\D/`
   - Takes the last 10 digits to ensure max 10 characters
   - Returns `nil` for empty strings or invalid inputs

2. **Updated `generate_qr_data/1` function**:
   - Now pipes the `variable_symbol` through `sanitize_variable_symbol/1` before using it
   - Updated the docstring example to show the sanitized output (e.g., `"PAY-20251016-0001"` becomes `"2025101600"`)

### How It Works:

For invoice numbers like `"PAY-20251130-0001"`:
- The function strips all non-digit characters: `"2025113000001"`
- Then takes the last 10 characters: `"2511300001"`
- This ensures compliance with Czech banking QR code standards

The sanitization is done automatically whenever a QR code is generated, so no changes are needed in the calling code.

---

