<!-- Generated by SpecStory -->

<!-- vscode Session 5f82c0a7-9bf6-4db0-b7ae-e8799dd17534 (2025-10-16 14:49Z) -->

# Exporting paid orders to POHODA accounting software (2025-10-16 14:49Z)

_**User (2025-10-16 14:53Z)**_

Now I would like to be able to export paid orders into POHODA accounting software. Would you be able to help with that? Definitely lookup to the internet and try to find any information about it.

---

_**Assistant (copilot/claude-sonnet-4.5)**_

I'll help you with exporting paid orders to POHODA accounting software. Let me search for information about POHODA's API and integration options.

Based on my research, POHODA is a popular Czech/Slovak accounting software that supports XML-based data import. Here's what I found:

## POHODA Integration Overview

POHODA supports importing data via XML files following their specific schema. The most common approach is:

1. **XML Export Format**: POHODA uses a proprietary XML format for data import
2. **mServer**: POHODA has an optional mServer component for remote API access
3. **File-based Import**: The simplest method is generating XML files that can be imported directly

## Implementation Plan

I'll create a system to export paid orders as POHODA-compatible XML files. Here's what I'll build:

````elixir
defmodule CozyCheckout.Pohoda do
  @moduledoc """
  Handles export of paid orders to POHODA accounting software XML format.
  """

  alias CozyCheckout.Sales
  alias CozyCheckout.Sales.{Order, OrderItem}

  @doc """
  Exports paid orders to POHODA XML format.
  Returns XML string that can be saved to file or sent to POHODA mServer.
  """
  def export_orders(order_ids) when is_list(order_ids) do
    orders = Sales.list_orders_for_pohoda_export(order_ids)
    generate_xml(orders)
  end

  def export_orders(date_from, date_to) do
    orders = Sales.list_paid_orders_by_date(date_from, date_to)
    generate_xml(orders)
  end

  defp generate_xml(orders) do
    """
    <?xml version="1.0" encoding="UTF-8"?>
    <dat:dataPack id="Export" ico="#{ico()}" application="CozyCheckout" version="2.0" note="Export paid orders" xmlns:dat="http://www.stormware.cz/schema/version_2/data.xsd" xmlns:inv="http://www.stormware.cz/schema/version_2/invoice.xsd" xmlns:typ="http://www.stormware.cz/schema/version_2/type.xsd">
    #{Enum.map_join(orders, "\n", &order_to_xml/1)}
    </dat:dataPack>
    """
  end

  defp order_to_xml(order) do
    """
      <dat:dataPackItem id="#{order.order_number}" version="2.0">
        <inv:invoice version="2.0">
          <inv:invoiceHeader>
            <inv:invoiceType>issuedInvoice</inv:invoiceType>
            <inv:number>
              <typ:numberRequested>#{order.order_number}</typ:numberRequested>
            </inv:number>
            <inv:date>#{format_date(order.inserted_at)}</inv:date>
            <inv:dateTax>#{format_date(order.inserted_at)}</inv:dateTax>
            <inv:dateAccounting>#{format_date(order.inserted_at)}</inv:dateAccounting>
            <inv:text>Order #{order.order_number}</inv:text>
            <inv:partnerIdentity>
              <typ:address>
                <typ:company>#{escape_xml(order.guest.name)}</typ:company>
              </typ:address>
            </inv:partnerIdentity>
            <inv:paymentType>
              <typ:paymentType>#{payment_type_to_pohoda(order.payments)}</typ:paymentType>
            </inv:paymentType>
            <inv:account>
              <typ:ids>#{default_account()}</typ:ids>
            </inv:account>
            <inv:symPar>#{order.order_number}</inv:symPar>
          </inv:invoiceHeader>
          <inv:invoiceDetail>
    #{Enum.map_join(active_order_items(order), "\n", &order_item_to_xml/1)}
          </inv:invoiceDetail>
          <inv:invoiceSummary>
            <inv:homeCurrency>
              <typ:priceNone>#{order.total_amount}</typ:priceNone>
            </inv:homeCurrency>
          </inv:invoiceSummary>
        </inv:invoice>
      </dat:dataPackItem>
    """
  end

  defp order_item_to_xml(item) do
    """
            <inv:invoiceItem>
              <inv:text>#{escape_xml(item.product_name)}</inv:text>
              <inv:quantity>#{item.quantity}</inv:quantity>
              <inv:unit>#{item.unit_amount || "pcs"}</inv:unit>
              <inv:coefficient>1.0</inv:coefficient>
              <inv:payVAT>false</inv:payVAT>
              <inv:rateVAT>#{vat_rate_to_pohoda(item.vat_rate)}</inv:rateVAT>
              <inv:homeCurrency>
                <typ:unitPrice>#{item.price}</typ:unitPrice>
              </inv:homeCurrency>
            </inv:invoiceItem>
    """
  end

  defp active_order_items(order) do
    Enum.filter(order.order_items, &is_nil(&1.deleted_at))
  end

  defp format_date(%DateTime{} = datetime) do
    datetime
    |> DateTime.to_date()
    |> Date.to_iso8601()
  end

  defp escape_xml(text) when is_binary(text) do
    text
    |> String.replace("&", "&amp;")
    |> String.replace("<", "&lt;")
    |> String.replace(">", "&gt;")
    |> String.replace("\"", "&quot;")
    |> String.replace("'", "&apos;")
  end

  defp vat_rate_to_pohoda(rate) when is_struct(rate, Decimal) do
    case Decimal.to_string(rate) do
      "0" -> "none"
      "15" -> "low"
      "21" -> "high"
      _ -> "none"
    end
  end

  defp payment_type_to_pohoda(payments) when is_list(payments) do
    case List.first(payments) do
      %{method: "card"} -> "card"
      %{method: "cash"} -> "cash"
      _ -> "cash"
    end
  end

  # Configuration helpers - these should be moved to application config
  defp ico do
    Application.get_env(:cozy_checkout, :pohoda_ico, "12345678")
  end

  defp default_account do
    Application.get_env(:cozy_checkout, :pohoda_default_account, "1")
  end
end
````

````elixir
// ...existing code...

  @doc """
  Lists orders with preloaded associations for POHODA export.
  """
  def list_orders_for_pohoda_export(order_ids) do
    from(o in Order,
      where: o.id in ^order_ids,
      where: o.status == "paid",
      preload: [:guest, :order_items, :payments]
    )
    |> Repo.all()
  end

  @doc """
  Lists paid orders within a date range for POHODA export.
  """
  def list_paid_orders_by_date(date_from, date_to) do
    from(o in Order,
      where: o.status == "paid",
      where: o.inserted_at >= ^date_from,
      where: o.inserted_at <= ^date_to,
      preload: [:guest, :order_items, :payments],
      order_by: [asc: o.inserted_at]
    )
    |> Repo.all()
  end

// ...existing code...
````

````elixir
defmodule CozyCheckoutWeb.PohodaExportLive.Index do
  use CozyCheckoutWeb, :live_view

  alias CozyCheckout.Pohoda
  alias CozyCheckout.Sales

  @impl true
  def mount(_params, _session, socket) do
    today = Date.utc_today()
    first_day_of_month = Date.beginning_of_month(today)

    {:ok,
     socket
     |> assign(:page_title, "POHODA Export")
     |> assign(:date_from, first_day_of_month)
     |> assign(:date_to, today)
     |> assign(:orders, [])
     |> assign(:selected_orders, MapSet.new())
     |> load_orders()}
  end

  @impl true
  def handle_event("load_orders", %{"date_from" => from, "date_to" => to}, socket) do
    with {:ok, date_from} <- Date.from_iso8601(from),
         {:ok, date_to} <- Date.from_iso8601(to) do
      {:noreply,
       socket
       |> assign(:date_from, date_from)
       |> assign(:date_to, date_to)
       |> assign(:selected_orders, MapSet.new())
       |> load_orders()}
    else
      _ ->
        {:noreply, put_flash(socket, :error, "Invalid date format")}
    end
  end

  def handle_event("toggle_order", %{"order-id" => order_id}, socket) do
    selected = socket.assigns.selected_orders

    new_selected =
      if MapSet.member?(selected, order_id) do
        MapSet.delete(selected, order_id)
      else
        MapSet.put(selected, order_id)
      end

    {:noreply, assign(socket, :selected_orders, new_selected)}
  end

  def handle_event("select_all", _params, socket) do
    all_order_ids = Enum.map(socket.assigns.orders, & &1.id)
    {:noreply, assign(socket, :selected_orders, MapSet.new(all_order_ids))}
  end

  def handle_event("deselect_all", _params, socket) do
    {:noreply, assign(socket, :selected_orders, MapSet.new())}
  end

  def handle_event("export", _params, socket) do
    selected_ids = MapSet.to_list(socket.assigns.selected_orders)

    if Enum.empty?(selected_ids) do
      {:noreply, put_flash(socket, :error, "Please select at least one order to export")}
    else
      xml_content = Pohoda.export_orders(selected_ids)
      filename = "pohoda_export_#{Date.to_iso8601(Date.utc_today())}.xml"

      {:noreply,
       socket
       |> put_flash(:info, "Export generated successfully")
       |> push_event("download", %{content: xml_content, filename: filename})}
    end
  end

  defp load_orders(socket) do
    date_from = DateTime.new!(socket.assigns.date_from, ~T[00:00:00])
    date_to = DateTime.new!(socket.assigns.date_to, ~T[23:59:59])

    orders = Sales.list_paid_orders_by_date(date_from, date_to)
    assign(socket, :orders, orders)
  end
end
````

````elixir
<Layouts.app flash={@flash} current_scope={:admin}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-slate-900 mb-2">POHODA Export</h1>
      <p class="text-slate-600">Export paid orders to POHODA accounting software</p>
    </div>

    <!-- Date Range Filter -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <form phx-submit="load_orders" class="flex flex-wrap gap-4 items-end">
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-slate-700 mb-2">Date From</label>
          <input
            type="date"
            name="date_from"
            value={@date_from}
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-slate-700 mb-2">Date To</label>
          <input
            type="date"
            name="date_to"
            value={@date_to}
            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <button
          type="submit"
          class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors"
        >
          Load Orders
        </button>
      </form>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
      <div class="p-4 border-b border-slate-200 flex justify-between items-center">
        <div class="flex gap-2">
          <button
            phx-click="select_all"
            class="px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
          >
            Select All
          </button>
          <button
            phx-click="deselect_all"
            class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 rounded-lg transition-colors"
          >
            Deselect All
          </button>
        </div>

        <div class="text-sm text-slate-600">
          {MapSet.size(@selected_orders)} / {length(@orders)} selected
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">
                Select
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">
                Order Number
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">
                Guest
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">
                Date
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">
                Items
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">
                Total
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-slate-200">
            <tr :for={order <- @orders} class="hover:bg-slate-50 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap">
                <input
                  type="checkbox"
                  checked={MapSet.member?(@selected_orders, order.id)}
                  phx-click="toggle_order"
                  phx-value-order-id={order.id}
                  class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500"
                />
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
                {order.order_number}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">
                {order.guest.name}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">
                {Calendar.strftime(order.inserted_at, "%Y-%m-%d %H:%M")}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">
                {Enum.count(Enum.filter(order.order_items, &is_nil(&1.deleted_at)))}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-900">
                {format_currency(order.total_amount)}
              </td>
            </tr>
          </tbody>
        </table>

        <div :if={@orders == []} class="text-center py-12 text-slate-500">
          No paid orders found for the selected date range
        </div>
      </div>
    </div>

    <!-- Export Button -->
    <div class="flex justify-end">
      <button
        phx-click="export"
        disabled={MapSet.size(@selected_orders) == 0}
        class={[
          "px-8 py-3 font-semibold rounded-lg transition-all",
          if(MapSet.size(@selected_orders) > 0,
            do: "bg-green-600 hover:bg-green-700 text-white shadow-lg hover:shadow-xl",
            else: "bg-slate-300 text-slate-500 cursor-not-allowed"
          )
        ]}
      >
        <.icon name="hero-arrow-down-tray" class="w-5 h-5 inline-block mr-2" />
        Export Selected Orders
      </button>
    </div>
  </div>
</Layouts.app>

<script>
  window.addEventListener("phx:download", (e) => {
    const { content, filename } = e.detail;
    const blob = new Blob([content], { type: "application/xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
</script>
````

````elixir
// ...existing code...

  scope "/", CozyCheckoutWeb do
    pipe_through [:browser, :require_authenticated_user]

    live_session :authenticated,
      on_mount: [{CozyCheckoutWeb.UserAuth, :ensure_authenticated}] do
      live "/dashboard", DashboardLive
      live "/guests", GuestLive.Index, :index
      live "/categories", CategoryLive.Index, :index
      live "/pricelists", PricelistLive.Index, :index
      live "/products", ProductLive.Index, :index
      live "/orders", OrderLive.Index, :index
      live "/orders/:id", OrderLive.Show, :show
      live "/orders/:id/edit", OrderLive.Edit, :edit
      live "/payments", PaymentLive.Index, :index
      live "/pohoda-export", PohodaExportLive.Index, :index
    end
  end

// ...existing code...
````

````elixir
// ...existing code...

# POHODA Export Configuration
config :cozy_checkout,
  pohoda_ico: "12345678",  # Your company ICO (tax ID)
  pohoda_default_account: "1"  # Default accounting account in POHODA

// ...existing code...
````

Now update the main dashboard to include a link to the POHODA export:

````elixir
// ...existing code...

        <.link
          navigate={~p"/pohoda-export"}
          class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all p-6 border-2 border-transparent hover:border-purple-500"
        >
          <.icon name="hero-arrow-down-tray" class="w-12 h-12 text-purple-600 mb-4" />
          <h3 class="text-xl font-semibold text-slate-900 mb-2">POHODA Export</h3>
          <p class="text-slate-600">Export paid orders to accounting</p>
        </.link>

// ...existing code...
````

This implementation provides:

1. **XML Export Format**: Generates POHODA-compatible XML files following their invoice schema
2. **Date Range Filtering**: Select orders within a specific date range
3. **Order Selection**: Choose which orders to export
4. **Download Functionality**: Exports XML file directly to browser
5. **Configuration**: ICO and default account configurable in `config.exs`

The XML format follows POHODA's standard for issued invoices (výdejky/faktury). You may need to adjust:
- VAT rates mapping based on Czech rates
- Payment types
- Account numbers
- Additional invoice fields

You can import the generated XML files into POHODA via **File → Import → XML**.

---

_**User (2025-10-16 15:00Z)**_

Great, please implement that then.

---

_**Assistant (copilot/claude-sonnet-4.5)**_

I'll implement the POHODA export functionality for you. Let me create all the necessary files. Now let me update the Sales context to add the necessary functions: Now let me add the POHODA-specific functions to the Sales context: 
```

```
Now let me create the LiveView for POHODA export: Now let me create the template for the POHODA export LiveView: Now let me update the router to add the POHODA export route: 
```

```
Now let me update the config to add POHODA settings: 
```

```
Now let me update the dashboard to add a link to the POHODA export: 
```

```
Now let me check if we need to add a POS layout since the template references it: Good, the POS layout already exists. Now let me create a documentation file for POHODA export: Now let me test if the implementation compiles correctly: Good! The code compiles. Let me fix those warnings. First, let's remove the unused aliases: 
```

```
Now let's check what the `current_scope` attribute should be: Let me check the Layouts module to see what the attribute should be: I see - the `current_scope` should be a map, not an atom. Let me remove that attribute since it's not being used in the app layout anyway: 
```

```
Now let's compile again to verify all warnings are fixed: Perfect! The code now compiles without warnings. Let me create a summary document of what was implemented:

## Summary

I've successfully implemented the POHODA export functionality for your Cozy Checkout application! Here's what was created:

### Files Created/Modified:

1. **`pohoda.ex`** - Core export module that:
   - Generates POHODA-compatible XML for issued invoices
   - Maps VAT rates (0% → none, 12% → low, 21% → high)
   - Maps payment types (card/cash)
   - Handles XML escaping for safety
   - Uses configurable ICO and account numbers

2. **`sales.ex`** - Added two new functions:
   - `list_orders_for_pohoda_export/1` - Gets paid orders by IDs
   - `list_paid_orders_by_date/2` - Gets paid orders by date range

3. **`index.ex`** - LiveView module with:
   - Date range filtering
   - Order selection (individual, select all, deselect all)
   - Export functionality with file download
   - Flash message feedback

4. **`index.html.heex`** - UI with:
   - Clean, professional interface
   - Date range picker
   - Order table with checkboxes
   - Order details (number, guest, date, items, total)
   - Export button with visual feedback
   - JavaScript for file download

5. **`router.ex`** - Added route:
   - `/pohoda-export` → PohodaExportLive.Index

6. **`dashboard_live.ex`** - Added dashboard card:
   - Link to POHODA Export with icon and description

7. **`config.exs`** - Added configuration:
   - `pohoda_ico` - Your company tax ID (default: "12345678")
   - `pohoda_default_account` - Default accounting account (default: "1")

8. **`POHODA_EXPORT.md`** - Comprehensive documentation covering:
   - Configuration guide
   - Usage instructions
   - Import process
   - VAT and payment type mappings
   - Troubleshooting
   - Technical details

### How to Use:

1. **Configure** your company details in `config.exs`:
   ```elixir
   config :cozy_checkout,
     pohoda_ico: "YOUR_ICO_NUMBER",
     pohoda_default_account: "YOUR_ACCOUNT_NUMBER"
   ```

2. **Access** the export interface:
   - From dashboard: Click "POHODA Export"
   - Or navigate to: `/pohoda-export`

3. **Export orders**:
   - Select date range
   - Choose which orders to export
   - Click "Export Selected Orders"
   - XML file downloads automatically

4. **Import to POHODA**:
   - Open POHODA
   - File → Import → XML
   - Select the downloaded XML file

### Features:

✅ Only exports paid orders (status = "paid")
✅ Excludes soft-deleted order items
✅ Generates POHODA-compatible XML format
✅ Includes guest information as partner/customer
✅ Maps VAT rates and payment types
✅ Date range filtering
✅ Bulk selection tools
✅ Automatic file download
✅ Fully responsive UI

The implementation is complete and ready to use! You just need to update the ICO and account number in the config file before using it in production.

---

_**User (2025-10-16 15:02Z)**_

When trying to export I got this error:
key :product_name not found in:

    %CozyCheckout.Sales.OrderItem{
      __meta__: #Ecto.Schema.Metadata<:loaded, "order_items">,
      id: "3c31965c-7c35-4558-b568-6003b1c8386a",
      quantity: 1,
      unit_amount: nil,
      unit_price: Decimal.new("50.00"),
      vat_rate: Decimal.new("21.00"),
      subtotal: Decimal.new("50.00"),
      deleted_at: nil,
      order_id: "0b2ea4ef-cd7f-4606-a580-7a3beee2dbdb",
      order: #Ecto.Association.NotLoaded<association :order is not loaded>,
      product_id: "e8578cdd-5ee6-453f-803a-9dbc5c48ae71",
      product: #Ecto.Association.NotLoaded<association :product is not loaded>,
      inserted_at: ~U[2025-10-16 14:31:53Z],
      updated_at: ~U[2025-10-16 14:31:53Z]
    }

---

_**Assistant (copilot/claude-sonnet-4.5)**_

I see the issue! The `OrderItem` schema doesn't have a `product_name` field. Let me check the schema structure and fix the POHODA export to handle this correctly. I see - the `order_items` table doesn't store the product name directly, it only has a reference to the product. We need to either:
1. Preload the product association and get the name from there
2. Add a `product_name` field to store it at the time of order creation (better for historical accuracy)

Let me check if products are already preloaded in the POHODA export queries: I see the issue - we're preloading `order_items` but not the nested `product` association. We need to preload the products for each order item. Let me fix both functions: 
```

```


---

