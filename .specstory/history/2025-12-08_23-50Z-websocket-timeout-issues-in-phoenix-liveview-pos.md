<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- vscode Session 62684bc4-58b2-4f6b-816a-f3ccb4d2e0ee (2025-12-08 23:50Z) -->

# WebSocket timeout issues in Phoenix LiveView POS (2025-12-08 23:50Z)

_**User (2025-12-08 23:53Z)**_

I run this application on a server and my goal is to use it as a POS in my bar. The thing is, it seems that websocket is closed pretty soon after some inactivity. At least it always takes quite some time to start working again. Is this a well known behaviour? And is there a way to keep it responsive for a longer time?

---

_**Agent (model copilot/claude-sonnet-4.5)**_

Yes, this is a well-known behavior with Phoenix LiveView! The LiveView connection uses WebSockets, and there are several factors that can cause the connection to close during inactivity:

## Common Causes

1. **Browser Tab Sleeping** - Mobile browsers (especially iOS Safari) aggressively sleep inactive tabs to save battery
2. **WebSocket Timeout** - The connection times out after periods of inactivity
3. **Network/Proxy Timeouts** - Reverse proxies (nginx, etc.) may close idle connections
4. **Phoenix Default Settings** - LiveView has default timeout settings

## Solutions

### 1. **Keep the Connection Alive (Recommended for POS)**

Add this to your LiveSocket configuration in `app.js`:

````javascript
// ...existing code...

const liveSocket = new LiveSocket("/live", Socket, {
  longPollFallbackMs: 2500,
  params: {_csrf_token: csrfToken},
  hooks: {...colocatedHooks, ...Hooks},
  // Add these heartbeat settings to keep connection alive
  heartbeatIntervalMs: 15000,  // Send heartbeat every 15 seconds (default: 30s)
  timeout: 20000                // Wait 20s for server response (default: 10s)
})
````

### 2. **Prevent Browser Tab Sleeping**

For tablets used as POS terminals, add a keepalive mechanism. Add this JavaScript to maintain activity:

````javascript
// ...existing code after liveSocket.connect()...

// For POS tablets - prevent sleep and maintain connection
if (/pos/.test(window.location.pathname)) {
  // Send a ping every 30 seconds to keep connection alive
  setInterval(() => {
    if (liveSocket.isConnected()) {
      // Touch a DOM element to prevent sleep
      document.body.style.transform = 'translateZ(0)'
      setTimeout(() => {
        document.body.style.transform = ''
      }, 100)
    }
  }, 30000)
  
  // Request wake lock API (keeps screen on)
  if ('wakeLock' in navigator) {
    let wakeLock = null
    const requestWakeLock = async () => {
      try {
        wakeLock = await navigator.wakeLock.request('screen')
        wakeLock.addEventListener('release', () => {
          console.log('Screen Wake Lock released')
        })
      } catch (err) {
        console.error('Wake Lock error:', err)
      }
    }
    requestWakeLock()
    
    // Re-acquire wake lock if page becomes visible again
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        requestWakeLock()
      }
    })
  }
}
````

### 3. **Configure Server-Side Timeout**

In `endpoint.ex`:

````elixir
// ...existing code...

socket "/live", Phoenix.LiveView.Socket,
  websocket: [
    connect_info: [session: @session_options],
    timeout: :infinity  # Never timeout (or use a long timeout like 60_000)
  ],
  longpoll: [connect_info: [session: @session_options]]
````

### 4. **Configure Nginx/Reverse Proxy** (if applicable)

If you're using nginx, add to your config:

```nginx
# Keep WebSocket connections alive
proxy_read_timeout 3600s;
proxy_send_timeout 3600s;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

## Recommended Complete Solution

For a POS system, I recommend implementing **all of these changes**:

1. **Shorter heartbeat interval** (15s instead of 30s)
2. **Wake Lock API** (keeps tablet screen active)
3. **Periodic keepalive pings** on POS routes
4. **Increased server timeout**

This combination will ensure your POS terminal stays responsive even during quiet periods in your bar! üç∫

The reconnection time you're experiencing (a few seconds) is normal - LiveView automatically reconnects and restores state when the connection is re-established. But with these changes, the connection should stay alive much longer.

---

_**User (2025-12-08 23:54Z)**_

Great, then implement all you can. I will implement nginx solution part myself

---

_**Agent (model copilot/claude-sonnet-4.5)**_

<tool-use data-tool-type="task" data-tool-name="manage_todo_list">
<details>
<summary>Tool use: **manage_todo_list** ‚Ä¢ Using "Manage and track todo items for task planning"</summary>

**Created 5 todos**

- [-] Read current app.js file
  > Read the assets/js/app.js file to understand the current LiveSocket configuration
- [ ] Update LiveSocket heartbeat configuration
  > Add heartbeatIntervalMs and timeout settings to LiveSocket configuration
- [ ] Add POS keepalive mechanism
  > Add JavaScript code to prevent tab sleeping and maintain connection for POS routes
- [ ] Read endpoint.ex file
  > Read the lib/cozy_checkout_web/endpoint.ex file to see current socket configuration
- [ ] Update server-side timeout
  > Configure WebSocket timeout in endpoint.ex

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="copilot_readFile">
<details>
<summary>Tool use: **copilot_readFile** ‚Ä¢ Reading [](file:///Users/michalhorcic/projects/ELIXIR/cozy_checkout/assets/js/app.js#1-1), lines 1 to 100</summary>


Read [](file:///Users/michalhorcic/projects/ELIXIR/cozy_checkout/assets/js/app.js#1-1), lines 1 to 100

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="copilot_readFile">
<details>
<summary>Tool use: **copilot_readFile** ‚Ä¢ Reading [](file:///Users/michalhorcic/projects/ELIXIR/cozy_checkout/lib/cozy_checkout_web/endpoint.ex)</summary>


Read [](file:///Users/michalhorcic/projects/ELIXIR/cozy_checkout/lib/cozy_checkout_web/endpoint.ex)

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="copilot_readFile">
<details>
<summary>Tool use: **copilot_readFile** ‚Ä¢ Reading [](file:///Users/michalhorcic/projects/ELIXIR/cozy_checkout/assets/js/app.js#100-100), lines 100 to 244</summary>


Read [](file:///Users/michalhorcic/projects/ELIXIR/cozy_checkout/assets/js/app.js#100-100), lines 100 to 244

</details>
</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="manage_todo_list">
<details>
<summary>Tool use: **manage_todo_list** ‚Ä¢ Using "Manage and track todo items for task planning"</summary>

**Starting: *Update LiveSocket heartbeat configuration* (2/5)**

- [x] Read current app.js file
  > Read the assets/js/app.js file to understand the current LiveSocket configuration
- [-] Update LiveSocket heartbeat configuration
  > Add heartbeatIntervalMs and timeout settings to LiveSocket configuration
- [ ] Add POS keepalive mechanism
  > Add JavaScript code to prevent tab sleeping and maintain connection for POS routes
- [x] Read endpoint.ex file
  > Read the lib/cozy_checkout_web/endpoint.ex file to see current socket configuration
- [ ] Update server-side timeout
  > Configure WebSocket timeout in endpoint.ex

</details>
</tool-use>

---

