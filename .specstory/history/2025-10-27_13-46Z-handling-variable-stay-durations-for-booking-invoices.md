<!-- Generated by SpecStory -->

<!-- vscode Session ff943d56-1777-4847-b829-a561cdffdf35 (2025-10-27 13:46Z) -->

# Handling variable stay durations for booking invoices (2025-10-27 13:46Z)

_**User (2025-10-27 13:48Z)**_

When working with booking invoice items, I need to solve following scenario. I have one booking for lets say 11 people, but 2 of them will arrive one night later. So they will stay less number of nights. Do you have any idea how to solve it in a simple way? I need to keep UI as simple as possible. This is kind of an edge case, but I need to support it. Ask any additional questions to make it clear for you.

---

_**Assistant (copilot/claude-sonnet-4.5)**_

Looking at this scenario, I have a few clarifying questions to help design the best solution:

## Questions:

1. **Invoice Structure**: Currently, invoice items are tied to the booking invoice (not individual guests). Do you want to:
   - Keep it simple: Have multiple line items like "9 adults (3 nights)" and "2 adults (2 nights)"?
   - Or track which specific guests stayed how many nights?

2. **Guest Information**: Do you need to know *which* specific guests stayed fewer nights, or just the count?

3. **UI Location**: Where would staff enter this information?
   - During initial booking creation?
   - When generating the invoice?
   - When editing invoice items?

## My Recommended Solution:

Based on keeping the UI simple and your existing structure, I'd suggest:

**Allow multiple person-type items with different quantities and night counts**

Instead of:
- "11 adults @ 500 CZK/night for 3 nights"

Support:
- "9 adults @ 500 CZK/night for 3 nights"
- "2 adults @ 500 CZK/night for 2 nights"

This would involve:

1. **Add a `nights` field to `booking_invoice_items`** (defaults to the booking's total nights)
2. **Update the price calculation** to use `price_per_night × quantity × nights`
3. **In the invoice items UI**, allow staff to:
   - Add multiple line items for the same person type
   - Override the number of nights for each line item

**Example UI Flow:**
```
[ ] Adults (11 × 3 nights @ 500 CZK) = 16,500 CZK
                                       [Split Line] button

After clicking split:
[ ] Adults (9 × 3 nights @ 500 CZK) = 13,500 CZK
[ ] Adults (2 × 2 nights @ 500 CZK) = 2,000 CZK
```

Would this approach work for you? Should I proceed with implementing:
- Migration to add `nights` column to `booking_invoice_items`?
- Updated calculation logic?
- UI for splitting line items?

Or would you prefer a different approach?

---

_**User (2025-10-27 13:51Z)**_

1. keep it simple, we will track individual guests later and probably in different way
2. just the count
3. when editing invoice items

---

_**Assistant (copilot/claude-sonnet-4.5)**_

Based on your answers, here's my recommended solution:

## Solution: Add `nights` field to `booking_invoice_items`

Since you want to keep it simple and handle this when editing invoice items, I suggest:

1. **Add a `nights` column** to `booking_invoice_items` (defaults to booking's total nights)
2. **Update price calculation** to use `price_per_night × quantity × nights`
3. **In the invoice items UI**, allow staff to edit the nights for each line item

This way, for your scenario:
- Item 1: "9 adults × 3 nights @ 500 CZK" = 13,500 CZK
- Item 2: "2 adults × 2 nights @ 500 CZK" = 2,000 CZK

### Implementation Steps:

#### 1. Migration to add `nights` column:

````elixir
defmodule CozyCheckout.Repo.Migrations.AddNightsToBookingInvoiceItems do
  use Ecto.Migration

  def change do
    alter table(:booking_invoice_items) do
      add :nights, :integer, null: false, default: 1
    end
  end
end
````

#### 2. Update the schema:

````elixir
defmodule CozyCheckout.Bookings.BookingInvoiceItem do
  use Ecto.Schema
  import Ecto.Changeset

  @primary_key {:id, :binary_id, autogenerate: true}
  @foreign_key_type :binary_id
  schema "booking_invoice_items" do
    field :name, :string
    field :quantity, :integer
    field :price_per_night, :decimal
    field :nights, :integer, default: 1
    field :vat_rate, :decimal
    field :item_type, :string, default: "person"

    belongs_to :booking_invoice, CozyCheckout.Bookings.BookingInvoice

    timestamps(type: :utc_datetime)
  end

  @doc false
  def changeset(booking_invoice_item, attrs) do
    booking_invoice_item
    |> cast(attrs, [
      :booking_invoice_id,
      :name,
      :quantity,
      :price_per_night,
      :nights,
      :vat_rate,
      :item_type
    ])
    |> validate_required([:name, :quantity, :price_per_night, :nights, :vat_rate])
    |> validate_number(:quantity, greater_than_or_equal_to: 0)
    |> validate_number(:nights, greater_than: 0)
    |> validate_number(:price_per_night, greater_than_or_equal_to: 0)
    |> validate_number(:vat_rate, greater_than_or_equal_to: 0)
    |> validate_inclusion(:item_type, ~w(person extra))
  end

  @doc """
  Calculate the total price for this item: quantity × price_per_night × nights
  """
  def calculate_total(%__MODULE__{} = item) do
    Decimal.mult(item.quantity, item.price_per_night)
    |> Decimal.mult(item.nights)
  end
end
````

#### 3. Update the UI form to include nights field:

In your invoice items form (wherever you edit invoice items), add a nights input field next to quantity and price. The UI would show something like:

```
Adults: [9] people × [3] nights @ [500] CZK/night = 13,500 CZK
```

Would you like me to:
1. Generate the migration file?
2. Show you the complete updated schema?
3. Show you how to update the UI form for editing invoice items?

---

_**User (2025-10-27 13:55Z)**_

Please implement it completely now, when I switched to agent

---

_**Assistant (copilot/claude-sonnet-4.5)**_

I'll implement the complete solution to support variable stay durations for booking invoices. Let me start by gathering the necessary context and then implement all the required changes. 
```

```

```

```

```

```

```

```
Now let me find where the `calculate_totals` function is called to update those calls: Now I need to update this function to remove the `nights` parameter from `calculate_totals` and ensure items have the nights field set before calculation: 
```

```
Now let me search for where invoice items are created to ensure they get the nights field set: Now let me check where default invoice items are created when an invoice is initialized: Let me search for where invoice items get created initially: Let me search in the LiveView files for invoice forms: [object Object]

---

_**User (2025-10-27 13:55Z)**_

@agent Continue: "Continue to iterate?"

---

_**Assistant (copilot/claude-sonnet-4.5)**_

Now let me look at the invoice component to see where new items are added: Now I need to update the `add_item` handler to include the `nights` field with the booking's default nights: 
```

```
Now let me find the template part where invoice items are displayed and add the nights field to the form: I can see the edit form for items. I need to add the nights field. Let me look further to find where the display of items shows the values: Now I need to update both the edit and new item forms to include the nights field. Let me update the table header first and then the forms: 
```

```


---

